{% extends "base.html" %}
{% block page_content %}
    <h1>Game '{{ game.GameName }}'</h1>
    <canvas width="500" height="500" id="board">

    </canvas>
{% endblock %}
{% block scripts %}
    {{ super() }}
    <script type="text/javascript">
        let game_status = null;
        let selected_disk = null;
        function drawCanvas() {
            const DIMENSION = 10;
            const canvas = $('canvas#board')[0];
            const context = canvas.getContext("2d");
            const dimension = 500;
            const cell_side_length = dimension / DIMENSION;
            const disk_radius = 20;
            context.fillStyle = "#A0522D";
            for (let i = 0; i < DIMENSION; ++i) {
                const offset = (i % 2 == 0) ? 1 : 0;
                for (let j = 0; j < DIMENSION / 2; ++j) {
                    context.beginPath();
                    context.rect((j * 2 + offset) * cell_side_length, i * cell_side_length, cell_side_length, cell_side_length);
                    context.closePath();
                    context.fill();
                }
            }
            context.fill();
            context.fillStyle = "#000000";
            if (game_status == null) {
                console.log('no data loaded yet');
                return;
            }
            for (const black of game_status.BlackRegular) {
                context.beginPath();
                const offset = (black[0] % 2 == 0) ? 1 : 0;
                context.arc((black[1] + .5) * cell_side_length, (black[0] + .5) * cell_side_length, disk_radius, 0, Math.PI * 2);
                context.closePath();
                context.fill();
            }
            //TODO: draw kings
            context.fillStyle = "#FFFFFF";
            for (const white of game_status.WhiteRegular) {
                context.beginPath();
                const offset = (white[0] % 2 == 0) ? 1 : 0;
                context.arc((white[1] + .5) * cell_side_length, (white[0] + .5) * cell_side_length, disk_radius, 0, Math.PI * 2);
                context.fill();
                context.closePath();
            }
            context.fill();
        }
        function loadData() {
            $.get('{{ url_for('.get_game_status', game_id=game.GameId) }}', function (res) {
                game_status = res.data;
                drawCanvas();
            }, "json")
        }
        $(document).ready(function () {
            setInterval(loadData, 1000);
            drawCanvas();
            $('canvas#board').click(function (ev) {
                const clicked_disk = get_canvas_disk(ev);
                if (clicked_disk == null) {
                    if (selected_disk == null) {
                        // nothing happens
                    } else {
                        // try to move
                        $.post('{{ url_for('.game_move', game_id=game.GameId) }}', {
                            "src": selected_disk,
                            "dst": clicked_disk
                        }, function (res) {
                            loadData();
                        }, "json")
                    }
                } else if (is_own_disk(clicked_disk)) {
                    if (clicked_disk == selected_disk) {
                        selected_disk = null;
                    } else {
                        selected_disk = clicked_disk;
                    }
                } else {
                    // invalid click
                }
            });
        });
        $(document).resize(function () {
            drawCanvas();
        });
    </script>
{% endblock %}